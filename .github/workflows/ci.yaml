name: CI/CD

on:
  push:
    branches:
      - dev
      - staging
      - prod
    paths-ignore:
      - 'README.md'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-south-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: endtoend

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build
        run: go build -o go-web-app .

      - name: Test
        run: go test ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.56.2
          args: --timeout=5m --disable-all -E govet

  push-to-ecr:
    runs-on: ubuntu-latest
    needs: [build, lint]
    outputs:
      image-tag: ${{ steps.set-tag.outputs.short }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate image tag
        id: set-tag
        run: echo "short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          IMAGE_URI=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.set-tag.outputs.short }}
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

  update-helm:
    runs-on: ubuntu-latest
    needs: push-to-ecr

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          token: ${{ secrets.END_TO_END_PAT_TOKEN }}
          path: gitops

      - name: Detect environment from branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch detected: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == "dev" ]]; then
            echo "VALUES_FILE=helm/go-web-app/dev-values.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=dev.prasanna-aws.com" >> $GITHUB_ENV

          elif [[ "$BRANCH_NAME" == "staging" ]]; then
            echo "VALUES_FILE=helm/go-web-app/staging-values.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=staging.prasanna-aws.com" >> $GITHUB_ENV

          elif [[ "$BRANCH_NAME" == "production" ]]; then
            echo "VALUES_FILE=helm/go-web-app/prod-values.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=prasanna-aws.com" >> $GITHUB_ENV

          else
            echo "Unknown branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Update Helm values
        run: |
          sed -i "s|tag:.*|tag: ${{ needs.push-to-ecr.outputs.image-tag }}|" gitops/$VALUES_FILE
          sed -i "s|PLACEHOLDER_HOST|${INGRESS_HOST}|" gitops/$VALUES_FILE

      - name: Commit and push changes
        run: |
          cd gitops
          git config user.email "prasanna.m.loa@gmail.com"
          git config user.name "Prasanna"
          git add .
          git commit -m "ci: update image tag ${{ needs.push-to-ecr.outputs.image-tag }} [skip ci]" || echo "no changes"
          git push
