name: CI/CD

on:
  push:
    branches:
      - dev
      - staging
      - main
    paths-ignore:
      - 'helm/**'
      - 'k8s/**'
      - 'README.md'

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-south-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REPOSITORY: go-web-app

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go 1.22
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build
        run: go build -o go-web-app ./app

      - name: Test
        run: go test ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.56.2

  push-to-ecr:
    runs-on: ubuntu-latest
    needs: [build, lint]
    outputs:
      image-tag: ${{ steps.set-tag.outputs.short }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine short SHA
        id: set-tag
        run: echo "short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          IMAGE_URI=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ steps.set-tag.outputs.short }}
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

  update-helm:
    runs-on: ubuntu-latest
    needs: push-to-ecr
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GITOPS_REPO }}
          token: ${{ secrets.GITHUB_PAT }}
          path: gitops

      - name: Select environment values file & ingress host
        run: |
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "VALUES_FILE=gitops/helm/go-web-app/values-dev.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=go-app-dev.example.com" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            echo "VALUES_FILE=gitops/helm/go-web-app/values-staging.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=go-app-staging.example.com" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "VALUES_FILE=gitops/helm/go-web-app/values-prod.yaml" >> $GITHUB_ENV
            echo "INGRESS_HOST=go-app.example.com" >> $GITHUB_ENV

      - name: Update image tag and ingress host in Helm values
        run: |
          # Update image tag
          sed -i "s|tag:.*|tag: ${{ steps.set-tag.outputs.short }}|" $VALUES_FILE
          
          # Update ingress host
          sed -i "s|PLACEHOLDER_HOST|${INGRESS_HOST}|" $VALUES_FILE

      - name: Commit and push Helm changes
        run: |
          git config user.email "ci-bot@company.com"
          git config user.name "ci-bot"
          git add $VALUES_FILE
          git commit -m "ci: update image tag ${{ steps.set-tag.outputs.short }} and ingress host $INGRESS_HOST" || echo "no changes"
          git push

